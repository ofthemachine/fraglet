name: ðŸš€ Release fraglet-entrypoint

on:
  push:
    paths:
      - 'entrypoint/releases/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  get-version:
    name: ðŸ“‹ Get version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      release_file: ${{ steps.version.outputs.release_file }}
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Get version from release file
        id: version
        run: |
          # Find the latest release file
          RELEASE_FILE=$(find entrypoint/releases/ -name "*.md" -type f | sort | tail -n1)
          if [ -z "$RELEASE_FILE" ]; then
            echo "No release file found"
            exit 1
          fi

          # Extract version from filename (e.g., entrypoint/releases/v1.0.0.md -> v1.0.0)
          VERSION=$(basename "$RELEASE_FILE" .md)

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "release_file=${RELEASE_FILE}" >> $GITHUB_OUTPUT

          echo "Building version: ${VERSION}"

  build:
    name: ðŸ›  Build fraglet-entrypoint
    needs: get-version
    uses: ./.github/workflows/build-entrypoint-reusable.yml
    with:
      version: ${{ needs.get-version.outputs.version }}

  release:
    name: ðŸš€ Create GitHub Release
    needs: [get-version, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Download binaries from build
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093
        with:
          name: fraglet-entrypoint-binaries
          path: .
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Move binaries to root
        run: |
          mv entrypoint/fraglet-entrypoint-* . || true
          mv entrypoint/checksums.txt . || true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@5be0e66d93ac7ed76da52eca8bb058f665c3a5fe
        with:
          tag_name: ${{ needs.get-version.outputs.version }}
          name: fraglet-entrypoint ${{ needs.get-version.outputs.version }}
          body_path: ${{ needs.get-version.outputs.release_file }}
          files: |
            fraglet-entrypoint-*
            checksums.txt
          make_latest: true

